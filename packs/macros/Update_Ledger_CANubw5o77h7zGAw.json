{
  "name": "Update Ledger",
  "type": "script",
  "author": "qp7L9geXBa6D8uvq",
  "img": "icons/commodities/currency/coins-assorted-mix-copper.webp",
  "scope": "global",
  "command": "(async () => {\n\n  // 1. Ensure exactly one token is selected\n  if (canvas.tokens.controlled.length !== 1) {\n    ui.notifications.error(\"You must select exactly one token first.\");\n    return;\n  }\n\n  const actor = canvas.tokens.controlled[0].actor;\n  if (!actor) {\n    ui.notifications.error(\"Selected token has no actor.\");\n    return;\n  }\n\n  // 2. Find Ledger item\n  let ledger = actor.items.find(i => i.name === \"Ledger\");\n\n  // 3. Create Ledger if missing\n  if (!ledger) {\n    const created = await actor.createEmbeddedDocuments(\"Item\", [{\n      name: \"Ledger\",\n      type: \"treasure\",\n      system: {\n        price: { value: { gp: 0 } },\n        description: { value: \"<p><strong>Ledger</strong></p>\" }\n      }\n    }]);\n    ledger = created[0];\n  }\n\n  // 4. Dialog\n  const dialogContent = `\n  <form>\n    <div class=\"form-group\">\n      <label>Gold Amount (gp)</label>\n      <input type=\"number\" name=\"amount\" step=\"0.01\" />\n    </div>\n\n    <div class=\"form-group\">\n      <label>Description</label>\n      <textarea name=\"description\" rows=\"3\"></textarea>\n    </div>\n\n    <div class=\"form-group\">\n      <label>\n        <input type=\"checkbox\" name=\"subtractGold\" checked />\n        Subtract gold from character\n      </label>\n    </div>\n  </form>\n  `;\n\n  new Dialog({\n    title: \"Add Ledger Entry\",\n    content: dialogContent,\n    buttons: {\n      add: {\n        label: \"Add Entry\",\n        callback: async (html) => {\n          const subtractGold = html.find('[name=\"subtractGold\"]').is(':checked');\n          const amount = Number(html.find('[name=\"amount\"]').val());\n          const desc = html.find('[name=\"description\"]').val();\n\n          if (!amount || isNaN(amount)) {\n            ui.notifications.error(\"Invalid gold amount.\");\n            return;\n          }\n\n          const currentGp = ledger.system.price?.value?.gp ?? 0;\n          const newGp = currentGp + amount;\n\n          const oldDesc = ledger.system.description?.value ?? \"\";\n          const entry = `<p><strong>${amount.toFixed(2)} gp</strong> â€” ${desc}</p>`;\n\n          if (subtractGold) {\n            const actorGp = actor.inventory.coins.gp  ?? 0;\n\n            if (actorGp < amount) {\n              ui.notifications.error(\"Not enough gold.\");\n              return;\n            }\n\n            try {\n              await actor.inventory.removeCoins({ gp: amount });\n            } catch (err) {\n              console.error(\"addCoins failed:\", err);\n              ui.notifications.error(\"Gold subtraction failed. See console.\");\n              return;\n            }\n          }\n          \n          await ledger.update({\n            \"system.price.value.gp\": newGp,\n            \"system.description.value\": oldDesc + entry\n          });\n\n          ChatMessage.create({\n            content: `<strong>Ledger updated for: </strong> ${actor.name}`,\n            whisper: [], // leave empty for everyone to see\n          });\n        }\n      },\n      cancel: { label: \"Cancel\" }\n    },\n    default: \"add\"\n  }).render(true);\n\n})();",
  "folder": null,
  "ownership": {
    "default": 0,
    "qp7L9geXBa6D8uvq": 3
  },
  "flags": {},
  "_stats": {
    "compendiumSource": null,
    "duplicateSource": null,
    "exportSource": null,
    "coreVersion": "13.350",
    "systemId": "pf2e",
    "systemVersion": "7.7.0"
  },
  "_id": "CANubw5o77h7zGAw",
  "sort": 0,
  "_key": "!macros!CANubw5o77h7zGAw"
}
